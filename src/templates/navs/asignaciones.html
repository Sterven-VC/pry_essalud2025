{% extends './bases/base_navs.html' %}
{% block body %}
<div class="container mt-4">
    <h2 class="mb-4">Asignación de Doctores a Actividades</h2>
    <div class="row mb-3">
        <div class="col-md-3">
            <label for="departamentoFiltro">Departamento:</label>
            <select id="departamentoFiltro" class="form-control">
                {% for dep in departamentos %}
                <option value="{{ dep.id }}">{{ dep.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="servicioFiltro">Servicio:</label>
            <select id="servicioFiltro" class="form-control">
                <option value="">Todos</option>
                {% for serv in servicios %}
                <option value="{{ serv.id }}">{{ serv.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="doctorFiltro">Doctor:</label>
            <select id="doctorFiltro" class="form-control">
                <option value="">Todos</option>
                {% for doc in doctores %}
                <option value="{{ doc.id }}">{{ doc.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3 mt-2">
            <label for="mes">Mes:</label>
            <input type="month" id="mes" class="form-control" value="{{ mes_actual }}">
        </div>
    </div>
    <div id="calendario-matriz" class="table-responsive"></div>
</div>

<link rel="stylesheet" href="/static/css/style.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_ACTIVIDADES = '/api/actividades';
const API_DOCTORES = '/api/doctores';
const API_ASIGNACIONES = '/api/asignaciones';
const API_ASIGNAR = '/api/asignar_doctor';
const API_QUITAR = '/api/quitar_doctor';

let actividades = [];
let doctores = [];
let asignaciones = [];

$(document).ready(function() {
    cargarActividades();
    cargarDoctores();
    cargarCalendario();

    $('#mes').on('change', cargarCalendario);
    $('#doctorFiltro').on('change', renderizarMatriz);

    // Filtros dependientes para selects
    $('#departamentoFiltro').on('change', function() {
        let depId = $(this).val();
        // Actualizar servicios
        $.get(`/get_servicios_by_departamento/${depId}`, function(data) {
            let select = $('#servicioFiltro');
            select.empty().append('<option value="">Todos</option>');
            (data.servicios || []).forEach(s => select.append(`<option value="${s.id}">${s.nombre}</option>`));
            select.trigger('change');
        });
    });
    $('#servicioFiltro').on('change', function() {
        let servId = $(this).val();
        if (servId) {
            $.get(`/api/actividades_by_servicio/${servId}`, function(data) {
                actividades = (data.actividades || []);
                renderizarMatriz();
            });
        } else {
            actividades = [];
            renderizarMatriz();
        }
    });
});

function cargarActividades() {
    $.get('/api/actividades', function(data) {
        actividades = data.actividades;
        renderizarMatriz();
    });
}

function cargarDoctores() {
    $.get('/api/doctores', function(data) {
        doctores = data.doctores;
        let select = $('#doctorFiltro');
        select.empty().append('<option value="">Todos</option>');
        doctores.forEach(d => select.append(`<option value="${d.id}">${d.nombre}</option>`));
    });
}

function cargarCalendario() {
    let mes = $('#mes').val();
    if (!mes) return;
    $.get(`${API_ASIGNACIONES}?mes=${mes}`, function(data) {
        asignaciones = data.asignaciones;
        renderizarMatriz();
    });
}

function renderizarMatriz() {
    let mes = $('#mes').val();
    if (!mes) return;
    let [anio, mesNum] = mes.split('-');
    let diasMes = new Date(anio, mesNum, 0).getDate();
    // Ordenar actividades por hora de inicio (y fin si existe)
    let actividadesFiltradas = actividades.slice().sort((a, b) => {
        if (a.hora_inicio && b.hora_inicio) {
            return a.hora_inicio.localeCompare(b.hora_inicio);
        }
        return 0;
    });
    let doctorFiltro = $('#doctorFiltro').val();

    let html = '<table class="table table-bordered table-sm matriz-asignaciones">';
    html += '<thead><tr>';
    html += '<th>Actividad</th><th>Hora</th>';
    for (let d = 1; d <= diasMes; d++) {
        html += `<th>${d}</th>`;
    }
    html += '</tr></thead><tbody>';
    actividadesFiltradas.forEach(act => {
        let hora = '';
        if (act.hora_inicio && act.hora_fin) {
            hora = act.hora_inicio + ' - ' + act.hora_fin;
        } else if (act.hora_inicio) {
            hora = act.hora_inicio;
        } else {
            hora = '';
        }
        html += `<tr><td>${act.nombre}</td><td>${hora}</td>`;
        for (let d = 1; d <= diasMes; d++) {
            let fecha = `${anio}-${mesNum.padStart(2, '0')}-${d.toString().padStart(2, '0')}`;
            let asignados = asignaciones.filter(a => a.actividad_id == act.id && a.fecha == fecha);
            let cellContent = asignados.map(a => {
                let doc = doctores.find(d => d.id == a.doctor_id);
                return `<span class="badge badge-info mr-1">${doc ? doc.nombre : 'Doctor'}</span> <a href="#" class="text-danger quitar-doctor" data-actividad="${act.id}" data-fecha="${fecha}" data-doctor="${a.doctor_id}">&times;</a>`;
            }).join('<br>');
            let btnAdd = '';
            // Solo mostrar el + si hay menos de 2 doctores y hay un doctor seleccionado en el filtro y no está ya asignado
            if (asignados.length < 2 && doctorFiltro && !asignados.some(a => a.doctor_id == doctorFiltro)) {
                btnAdd = `<button class="btn btn-sm btn-success asignar-doctor" data-actividad="${act.id}" data-fecha="${fecha}">+</button>`;
            }
            html += `<td>${cellContent} ${btnAdd}</td>`;
        }
        html += '</tr>';
    });
    html += '</tbody></table>';
    $('#calendario-matriz').html(html);

    // Evento para asignar doctor al hacer clic en +
    $('.asignar-doctor').off('click').on('click', function() {
        let actividadId = $(this).data('actividad');
        let fecha = $(this).data('fecha');
        let doctorId = $('#doctorFiltro').val();
        if (!doctorId) {
            alert('Seleccione un doctor en la cabecera.');
            return;
        }
        $.ajax({
            url: API_ASIGNAR,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({actividad_id: actividadId, fecha: fecha, doctor_id: doctorId}),
            success: function() {
                cargarCalendario();
            },
            error: function(xhr) {
                alert(xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Error al asignar doctor.');
            }
        });
    });
    // Evento para quitar doctor
    $('.quitar-doctor').off('click').on('click', function(e) {
        e.preventDefault();
        let actividadId = $(this).data('actividad');
        let fecha = $(this).data('fecha');
        let doctorId = $(this).data('doctor');
        quitarDoctor(actividadId, fecha, doctorId);
    });
}

function quitarDoctor(actividadId, fecha, doctorId) {
    $.ajax({
        url: API_QUITAR,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({actividad_id: actividadId, fecha: fecha, doctor_id: doctorId}),
        success: cargarCalendario
    });
}
</script>
<style>
.matriz-asignaciones th, .matriz-asignaciones td { text-align: center; vertical-align: middle; }
.matriz-asignaciones td { min-width: 90px; }
</style>
{% endblock %}
